from __future__ import annotations

from typing import Dict


_MESSAGES: Dict[str, Dict[str, str]] = {
    "en": {
        "error_vault_required": "Error: --vault or VAULT_PATH is required.",
        "error_vault_missing": "Error: vault path does not exist: {vault}",
        "config_exists": "oka.toml already exists at {path}.",
        "config_created": "Created {path}",
        "doctor_report": "Doctor Report",
        "doctor_vault": "Vault: {vault}",
        "doctor_path_checks": "Path checks: exists={exists} is_dir={is_dir} readable={readable}",
        "doctor_locks": "Locks: write-lease present={present} stale={stale} | offline-lock present={opresent} stale={ostale}",
        "doctor_encoding": "Encoding: utf8_bom={bom} non_utf8={non_utf8}",
        "doctor_line_endings": "Line endings: lf={lf} crlf={crlf} mixed={mixed} none={none}",
        "doctor_scan": "Scan: scanned_files={scanned} skipped(non_md={non_md}, too_large={too_large}, no_permission={no_permission})",
        "doctor_recommendations": "Recommendations:",
        "doctor_rec_normalize": "Consider enabling format.normalize_on_write in oka.toml.",
        "doctor_rec_line_endings": "Normalize line endings to LF or CRLF for stable hashes.",
        "doctor_rec_write_lease": "Remove stale write-lease.json if no active runs exist.",
        "doctor_rec_offline_lock": "Remove stale offline-lock.json if no active runs exist.",
        "performance_summary": "Performance Summary",
        "performance_total": "Total: {total} ms",
        "performance_stages": "Stages: scan={scan}ms parse={parse}ms analyze={analyze}ms recommend={recommend}ms plan={plan}ms report={report}ms",
        "performance_io": "I/O: scanned_files={scanned} skipped(non_md={non_md}, too_large={too_large}, no_permission={no_permission})",
        "performance_cache": "Cache: present={present} hit_rate={hit_rate} incremental_updated={updated}",
        "performance_fast_path": "Fast-path: {fast_path}",
        "performance_skipped_by_reason": "Skipped by reason: {reasons}",
        "apply_summary": "Apply Summary",
        "apply_actions": "Actions: {count}",
        "apply_files": "Files affected: {count}",
        "apply_top_files": "Top files:",
        "apply_prompt": "Apply changes? [y/n/preview]: ",
        "apply_preview": "Preview",
        "apply_preview_item": "{id} {type} -> {target} (conf {confidence:.2f})",
        "apply_prompt_invalid": "Please answer y, n, or preview.",
        "starvation_detected": "Vault sync activity detected.",
        "starvation_mode_title": "Choose a fallback mode:",
        "starvation_option_append": "- append: apply append-block actions only",
        "starvation_option_all": "- all: apply all Class A actions",
        "starvation_option_abort": "- abort: stop without applying changes",
        "starvation_choice": "Fallback [append/all/abort]: ",
        "starvation_abort": "Apply aborted due to sync activity.",
        "starvation_tip": "Tip: pause sync or watch the vault for a quiet window, then retry.",
        "starvation_no_applicable": "No applicable actions available under starvation fallback.",
        "starvation_b1_disabled": "Starvation fallback disables Class B1 actions.",
        "starvation_prompt_invalid": "Please answer append, all, or abort.",
        "write_lease_denied": "Write lease denied: {message}",
        "git_dirty_require_clean": "Git working tree is dirty. Clean or use apply.git.policy=allow_dirty/auto_stash.",
        "git_stash_failed": "Git stash failed; aborting apply.",
        "git_autocommit_requires_clean": "auto_commit requires a clean repo or auto_stash policy.",
        "rollback_run_not_found": "Run log not found: {path}",
        "rollback_item_file_conflict": "Error: use either --item or --file, not both.",
        "rollback_no_action": "No matching action for id: {action_id}",
        "rollback_no_file": "No matching changes for file: {path}",
        "rollback_non_a": "Partial rollback only supports Class A actions. Use Git revert for others.",
        "rollback_missing_targets": "Missing targets for rollback: {targets}",
        "rollback_no_changes": "No changes applied.",
        "dependency_notice": "Note: dependencies not selected for rollback: {deps}",
        "conflict_target_missing": "Target file missing; cannot apply.",
        "conflict_file_missing": "Missing file; rollback skipped.",
        "conflict_missing_backup": "Missing file or backup; rollback skipped.",
        "conflict_changed_apply": "File changed since plan generation; apply skipped.",
        "conflict_changed_rollback": "File modified after apply; rollback skipped.",
        "conflict_b1_missing": "Source file missing; rename aborted.",
        "conflict_b1_target_exists": "Target path already exists; rename aborted.",
        "conflict_b1_changed": "File changed since plan generation; rename transaction aborted.",
        "conflict_b1_remove_failed": "Failed to remove source after rename.",
        "conflict_b1_payload": "Missing source_path/target_path for rename action.",
        "conflict_b1_rollback": "Rollback for Class B actions is not supported. Use Git revert.",
        "howto_conflicts": "Conflicts generated by oka.\n\nApply diff manually:\n  patch -p0 < <file>.diff\n  git apply <file>.diff\n",
        "watch_summary": "watch: scanned={scanned} updated={updated} unchanged={unchanged} removed={removed}",
        "report_title": "Obsidian Assistant Report",
        "report_generated_at": "Generated at: {timestamp}",
        "report_vault": "Vault: {vault}",
        "report_summary": "## Summary",
        "report_metrics": "## Metrics",
        "report_next_steps": "## Next steps",
        "report_merge_preview": "## Merge preview (read-only)",
        "report_merge_item": "- {candidates} (avg confidence {confidence})",
        "report_tuning": "## Tuning tips",
        "report_metric_header": "| Metric | Value |",
        "report_metric_sep": "| --- | --- |",
        "report_metric_total_notes": "Total notes",
        "report_metric_frontmatter": "Notes with frontmatter",
        "report_metric_total_links": "Total links",
        "report_metric_broken": "Broken link candidates",
        "report_metric_orphan": "Orphan notes",
        "report_metric_actions": "Action items",
        "report_next_orphan": "- Review orphan notes and connect them to existing topics.",
        "report_next_broken": "- Investigate broken link candidates and fix or create targets.",
        "report_tuning_low": "- {count} suggestions are below confidence {threshold:.2f}.",
        "report_tuning_adjust": "- Adjust `scoring.w_content`, `scoring.w_title`, and `scoring.w_link` in oka.toml.",
        "report_tuning_filters": "- Increase `filters.path_penalty` or switch `profile` to conservative to reduce noise.",
        "related_heading": "## Related",
        "reason_broken_link": "Link target '{target}' not found in vault.",
    },
    "zh": {
        "error_vault_required": "错误：需要指定 --vault 或 VAULT_PATH。",
        "error_vault_missing": "错误：vault 路径不存在：{vault}",
        "config_exists": "oka.toml 已存在于 {path}。",
        "config_created": "已创建 {path}",
        "doctor_report": "Doctor 报告",
        "doctor_vault": "Vault：{vault}",
        "doctor_path_checks": "路径检查：exists={exists} is_dir={is_dir} readable={readable}",
        "doctor_locks": "锁：write-lease present={present} stale={stale} | offline-lock present={opresent} stale={ostale}",
        "doctor_encoding": "编码：utf8_bom={bom} non_utf8={non_utf8}",
        "doctor_line_endings": "换行：lf={lf} crlf={crlf} mixed={mixed} none={none}",
        "doctor_scan": "扫描：scanned_files={scanned} skipped(non_md={non_md}, too_large={too_large}, no_permission={no_permission})",
        "doctor_recommendations": "建议：",
        "doctor_rec_normalize": "建议在 oka.toml 中启用 format.normalize_on_write。",
        "doctor_rec_line_endings": "建议统一换行为 LF 或 CRLF，以保证哈希稳定。",
        "doctor_rec_write_lease": "如无正在运行的任务，可移除陈旧的 write-lease.json。",
        "doctor_rec_offline_lock": "如无正在运行的任务，可移除陈旧的 offline-lock.json。",
        "performance_summary": "性能摘要",
        "performance_total": "总耗时：{total} ms",
        "performance_stages": "阶段：scan={scan}ms parse={parse}ms analyze={analyze}ms recommend={recommend}ms plan={plan}ms report={report}ms",
        "performance_io": "I/O：scanned_files={scanned} skipped(non_md={non_md}, too_large={too_large}, no_permission={no_permission})",
        "performance_cache": "缓存：present={present} hit_rate={hit_rate} incremental_updated={updated}",
        "performance_fast_path": "快路径：{fast_path}",
        "performance_skipped_by_reason": "跳过原因：{reasons}",
        "apply_summary": "应用摘要",
        "apply_actions": "变更数：{count}",
        "apply_files": "影响文件数：{count}",
        "apply_top_files": "影响最多的文件：",
        "apply_prompt": "确认应用更改？[y/n/preview]：",
        "apply_preview": "预览",
        "apply_preview_item": "{id} {type} -> {target} (conf {confidence:.2f})",
        "apply_prompt_invalid": "请输入 y、n 或 preview。",
        "starvation_detected": "检测到同步活动。",
        "starvation_mode_title": "请选择回退策略：",
        "starvation_option_append": "- append：仅应用追加区块类动作",
        "starvation_option_all": "- all：应用所有 Class A 动作",
        "starvation_option_abort": "- abort：停止，不执行写入",
        "starvation_choice": "回退策略 [append/all/abort]：",
        "starvation_abort": "由于同步活动，已取消应用。",
        "starvation_tip": "提示：暂停同步或等待静默窗口后再重试。",
        "starvation_no_applicable": "在回退策略下没有可应用的动作。",
        "starvation_b1_disabled": "回退策略下禁用 Class B1 动作。",
        "starvation_prompt_invalid": "请输入 append、all 或 abort。",
        "write_lease_denied": "写入租约被拒绝：{message}",
        "git_dirty_require_clean": "Git 工作区有未提交变更，请清理或使用 apply.git.policy=allow_dirty/auto_stash。",
        "git_stash_failed": "Git stash 失败，已中止应用。",
        "git_autocommit_requires_clean": "auto_commit 需要干净仓库或 auto_stash 策略。",
        "rollback_run_not_found": "未找到 run 日志：{path}",
        "rollback_item_file_conflict": "错误：--item 与 --file 只能二选一。",
        "rollback_no_action": "未找到 action_id：{action_id}",
        "rollback_no_file": "未找到文件对应的变更：{path}",
        "rollback_non_a": "局部回滚仅支持 Class A，建议使用 Git revert。",
        "rollback_missing_targets": "回滚目标缺失：{targets}",
        "rollback_no_changes": "未产生任何变更。",
        "dependency_notice": "提示：以下依赖未被回滚：{deps}",
        "conflict_target_missing": "目标文件缺失，无法应用。",
        "conflict_file_missing": "文件缺失，已跳过回滚。",
        "conflict_missing_backup": "缺少文件或备份，已跳过回滚。",
        "conflict_changed_apply": "文件在计划生成后已变化，已跳过应用。",
        "conflict_changed_rollback": "文件在应用后被修改，已跳过回滚。",
        "conflict_b1_missing": "源文件缺失，重命名已中止。",
        "conflict_b1_target_exists": "目标路径已存在，重命名已中止。",
        "conflict_b1_changed": "文件在计划生成后已变化，事务已中止。",
        "conflict_b1_remove_failed": "重命名后删除源文件失败。",
        "conflict_b1_payload": "rename 动作缺少 source_path/target_path。",
        "conflict_b1_rollback": "Class B 操作不支持回滚，请使用 Git revert。",
        "howto_conflicts": "oka 产生的冲突文件。\n\n手动应用 diff：\n  patch -p0 < <file>.diff\n  git apply <file>.diff\n",
        "watch_summary": "watch：scanned={scanned} updated={updated} unchanged={unchanged} removed={removed}",
        "report_title": "Obsidian Assistant 报告",
        "report_generated_at": "生成时间：{timestamp}",
        "report_vault": "Vault：{vault}",
        "report_summary": "## 摘要",
        "report_metrics": "## 指标",
        "report_next_steps": "## 下一步建议",
        "report_merge_preview": "## 合并预览（只读）",
        "report_merge_item": "- {candidates}（平均置信度 {confidence}）",
        "report_tuning": "## 调参提示",
        "report_metric_header": "| 指标 | 数值 |",
        "report_metric_sep": "| --- | --- |",
        "report_metric_total_notes": "总笔记数",
        "report_metric_frontmatter": "含 frontmatter 笔记数",
        "report_metric_total_links": "链接总数",
        "report_metric_broken": "断链候选",
        "report_metric_orphan": "孤岛笔记",
        "report_metric_actions": "行动项",
        "report_next_orphan": "- 检查孤岛笔记并建立关联。",
        "report_next_broken": "- 处理断链候选并修复或创建目标。",
        "report_tuning_low": "- {count} 条建议低于置信度 {threshold:.2f}。",
        "report_tuning_adjust": "- 调整 oka.toml 中的 `scoring.w_content`、`scoring.w_title` 与 `scoring.w_link`。",
        "report_tuning_filters": "- 增大 `filters.path_penalty` 或切换到 conservative 以减少噪声。",
        "related_heading": "## 相关",
        "reason_broken_link": "链接目标 '{target}' 未在 vault 中找到。",
    },
}


def normalize_lang(lang: str) -> str:
    value = (lang or "en").strip().lower()
    if value.startswith("zh"):
        return "zh"
    return "en"


def t(lang: str, key: str, **kwargs: object) -> str:
    lang_key = normalize_lang(lang)
    message = _MESSAGES.get(lang_key, {}).get(key)
    if message is None:
        message = _MESSAGES["en"].get(key, key)
    try:
        return message.format(**kwargs)
    except Exception:
        return message
